apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: hive-metastore
  labels:
    app: hive
    hive: metastore
spec:
  serviceName: hive-metastore
  replicas: 1
  updateStrategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app: hive
      hive: metastore
{{- if .Values.presto.spec.hive.labels }}
{{ toYaml .Values.presto.spec.hive.labels | indent 6 }}
{{- end }}
  template:
    metadata:
      labels:
        app: hive
        hive: metastore
{{- if .Values.presto.spec.hive.labels }}
{{ toYaml .Values.presto.spec.hive.labels | indent 8 }}
{{- end }}
      annotations:
        hive-con***REMOVED***gmap-hash: {{ include (print $.Template.BasePath "/presto/hive-con***REMOVED***gmap.yaml") . | sha256sum }}
        hive-scripts-hash: {{ include (print $.Template.BasePath "/presto/hive-scripts-con***REMOVED***gmap.yaml") . | sha256sum }}
        hive-jmx-con***REMOVED***g-hash: {{ include (print $.Template.BasePath "/presto/hive-jmx-con***REMOVED***g.yaml") . | sha256sum }}
        presto-aws-credentials-secret-hash: {{ include (print $.Template.BasePath "/presto/presto-aws-credentials-secret.yaml") . | sha256sum }}
{{- if .Values.presto.spec.hive.annotations }}
{{ toYaml .Values.presto.spec.hive.annotations | indent 8 }}
{{- end }}
    spec:
      securityContext:
{{ toYaml .Values.presto.spec.hive.securityContext | indent 8 }}
{{- if .Values.presto.spec.hive.metastore.nodeSelector }}
      nodeSelector:
{{ toYaml .Values.presto.spec.hive.metastore.nodeSelector | indent 8 }}
{{- end }}
{{- if .Values.presto.spec.hive.metastore.tolerations }}
      tolerations:
{{ toYaml .Values.presto.spec.hive.metastore.tolerations | indent 8 }}
{{- end }}
{{- if .Values.presto.spec.hive.metastore.af***REMOVED***nity }}
      af***REMOVED***nity:
{{ toYaml .Values.presto.spec.hive.metastore.af***REMOVED***nity | indent 8 }}
{{- end }}
      containers:
      - name: metastore
        command: ["/hive-scripts/entrypoint.sh"]
        args: ["/opt/hive/bin/hive", "--service", "metastore"]
        image: "{{ .Values.presto.spec.hive.image.repository }}:{{ .Values.presto.spec.hive.image.tag }}"
        imagePullPolicy: {{ .Values.presto.spec.hive.image.pullPolicy }}
        ports:
        - name: meta
          containerPort: 9083
          protocol: TCP
        - containerPort: 8082
          name: metrics
{{- if .Values.presto.spec.hive.metastore.readinessProbe }}
        readinessProbe:
{{ toYaml .Values.presto.spec.hive.metastore.readinessProbe | indent 10 }}
{{- end }}
{{- if .Values.presto.spec.hive.metastore.livenessProbe }}
        livenessProbe:
{{ toYaml .Values.presto.spec.hive.metastore.livenessProbe | indent 10 }}
{{- end }}
        env:
        - name: HIVE_LOGLEVEL
          value: {{ upper .Values.presto.spec.hive.metastore.con***REMOVED***g.logLevel | quote}}
{{- if .Values.presto.spec.hive.metastore.con***REMOVED***g.jvm.initialRAMPercentage }}
        - name: JVM_INITIAL_RAM_PERCENTAGE
          value: {{ .Values.presto.spec.hive.metastore.con***REMOVED***g.jvm.initialRAMPercentage }}"
{{- end }}
{{- if .Values.presto.spec.hive.metastore.con***REMOVED***g.jvm.maxRAMPercentage }}
        - name: JVM_MAX_RAM_PERCENTAGE
          value: {{ .Values.presto.spec.hive.metastore.con***REMOVED***g.jvm.maxRAMPercentage }}"
{{- end }}
{{- if .Values.presto.spec.hive.metastore.con***REMOVED***g.jvm.maxRAMPercentage }}
        - name: JVM_MIN_RAM_PERCENTAGE
          value: {{ .Values.presto.spec.hive.metastore.con***REMOVED***g.jvm.minRAMPercentage }}"
{{- end }}
{{ include "hive-env" . | indent 8 }}
        - name: MY_MEM_REQUEST
          valueFrom:
            resourceFieldRef:
              containerName: metastore
              resource: requests.memory
        - name: MY_MEM_LIMIT
          valueFrom:
            resourceFieldRef:
              containerName: metastore
              resource: limits.memory
        volumeMounts:
        - name: hive-con***REMOVED***g
          mountPath: /hive-con***REMOVED***g
        - name: hive-scripts
          mountPath: /hive-scripts
{{- if .Values.presto.spec.hive.con***REMOVED***g.useHdfsCon***REMOVED***gMap }}
        - name: hdfs-con***REMOVED***g
          mountPath: /hadoop-con***REMOVED***g
{{- end }}
        - name: hive-jmx-con***REMOVED***g
          mountPath: /opt/jmx_exporter/con***REMOVED***g
        - name: hive-metastore-db-data
          mountPath: /var/lib/hive
        # openshift requires volumeMounts for VOLUMEs in a Docker***REMOVED***le
        - name: namenode-empty
          mountPath: /hadoop/dfs/name
        - name: datanode-empty
          mountPath: /hadoop/dfs/data
        - name: hadoop-logs
          mountPath: /opt/hadoop/logs
{{- if .Values.presto.spec.con***REMOVED***g.sharedVolume.enabled }}
        - name: hive-warehouse-data
          mountPath: {{ .Values.presto.spec.con***REMOVED***g.sharedVolume.mountPath }}
{{- end }}
{{- if or (not .Values.presto.spec.con***REMOVED***g.sharedVolume.enabled) (and .Values.presto.spec.con***REMOVED***g.sharedVolume.enabled (ne .Values.presto.spec.con***REMOVED***g.sharedVolume.mountPath "/user/hive/warehouse") ) }}
        - name: hive-warehouse-empty
          mountPath: /user/hive/warehouse
{{- end }}
        resources:
{{ toYaml .Values.presto.spec.hive.metastore.resources | indent 10 }}
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      terminationGracePeriodSeconds: {{ .Values.presto.spec.hive.terminationGracePeriodSeconds }}
      serviceAccount: hive
{{- if .Values.presto.spec.imagePullSecrets }}
      imagePullSecrets:
{{ toYaml .Values.presto.spec.imagePullSecrets | indent 8 }}
{{- end }}
      volumes:
      - name: hive-con***REMOVED***g
        con***REMOVED***gMap:
          name: hive-con***REMOVED***g
      - name: hive-scripts
        con***REMOVED***gMap:
          name: hive-scripts
          defaultMode: 0555
{{- if .Values.presto.spec.hive.con***REMOVED***g.useHdfsCon***REMOVED***gMap }}
      - name: hdfs-con***REMOVED***g
        con***REMOVED***gMap:
          name: {{ .Values.presto.spec.hive.con***REMOVED***g.hdfsCon***REMOVED***gMapName }}
{{- end }}
      - name: hive-jmx-con***REMOVED***g
        con***REMOVED***gMap:
          name: hive-jmx-con***REMOVED***g
      # these emptyDir volumes are necessary because Openshift requires VOLUMEs
      # in a Docker***REMOVED***le have a corresponding volumeMount
      - name: hive-warehouse-empty
        emptyDir: {}
      - name: namenode-empty
        emptyDir: {}
      - name: datanode-empty
        emptyDir: {}
      - name: hadoop-logs
        emptyDir: {}
      - name: hive-metastore-db-data
{{- if .Values.presto.spec.hive.metastore.storage.create }}
        persistentVolumeClaim:
          claimName: hive-metastore-db-data
{{- ***REMOVED*** }}
        emptyDir: {}
{{- end }}
{{- if .Values.presto.spec.con***REMOVED***g.sharedVolume.enabled }}
      - name: hive-warehouse-data
        persistentVolumeClaim:
          claimName: {{ .Values.presto.spec.con***REMOVED***g.sharedVolume.persistentVolumeClaimName }}
{{- end}}
