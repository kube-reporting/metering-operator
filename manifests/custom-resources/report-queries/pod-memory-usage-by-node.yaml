apiVersion: chargeback.coreos.com/v1alpha1
kind: ReportGenerationQuery
metadata:
  name: "pod-memory-usage-by-node"
spec:
  reportDataStores:
  - "pod-request-memory-bytes"
  view:
    disabled: true
  columns:
  - name: pod
    type: string
  - name: namespace
    type: string
  - name: node
    type: string
  - name: provider_id
    type: string
  - name: data_start
    type: timestamp
  - name: data_end
    type: timestamp
  - name: pod_request_memory_byte_seconds
    type: double
  query: |
    WITH usage_period AS (
        SELECT labels['pod'] as pod,
            labels['namespace'] as namespace,
            labels['node'] as node,
            labels,
            amount,
            timeprecision,
            split_part(split_part(element_at(labels, 'provider_id'), ':///', 2), '/', 2) as provider_id,
            "timestamp"
        FROM {{ dataStoreTableName "pod-request-memory-bytes" }}
    ),
    computed_usage AS (
        SELECT pod,
            namespace,
            node,
            provider_id,
            labels,
            amount * timeprecision as usage_amount,
            "timestamp"
        FROM usage_period
    )
    SELECT pod,
            namespace,
            node,
            provider_id,
            min("timestamp") as data_start,
            max("timestamp") as data_end,
            sum(usage_amount) as memory_usage_byte_seconds
    FROM computed_usage
    WHERE "timestamp" >= timestamp '{{.Report.StartPeriod | prestoTimestamp }}'
    AND "timestamp" <= timestamp '{{ .Report.EndPeriod | prestoTimestamp }}'
    GROUP BY pod, namespace, node, provider_id
    ORDER BY pod, namespace, node, provider_id
