- name: Query for {{ resource.apis | map(attribute='kind') | join(', ') }} resources with selector {{ label_selector }} to delete
  k8s_facts:
    api_version: "{{ item.api_version | default(omit) }}"
    kind: "{{ item.kind }}"
    namespace: "{{ namespace }}"
    label_selectors:
      - "{{ label_selector }}"
  loop: "{{ resource.apis }}"
  vars:
    label_selector: "{{ meteringcon***REMOVED***g_prune_label_key }}={{ resource.prune_label_value }}"
  register: to_delete

- name: Delete {{ resource.apis | map(attribute='kind') | join(', ') }} resources with selector {{ label_selector}}
  k8s:
    state: absent
    de***REMOVED***nition: "{{ to_delete.results | map(attribute='resources') | flatten }}"
  vars:
    label_selector: "{{ meteringcon***REMOVED***g_prune_label_key }}={{ resource.prune_label_value }}"
  when: to_delete.changed
