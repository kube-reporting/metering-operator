apiVersion: chargeback.coreos.com/v1alpha1
kind: ReportGenerationQuery
metadata:
  name: "pod-cpu-usage-by-node"
spec:
  reportDataStores:
  - "pod-request-cpu-cores"
  view:
    disabled: true
  columns:
  - name: pod
    type: string
  - name: namespace
    type: string
  - name: node
    type: string
  - name: provider_id
    type: string
  - name: data_start
    type: timestamp
  - name: data_end
    type: timestamp
  - name: pod_request_cpu_core_seconds
    type: double
  query: |
    WITH usage_period AS (
        SELECT labels['pod'] as pod,
            labels['namespace'] as namespace,
            labels['node'] as node,
            labels,
            amount,
            split_part(split_part(element_at(labels, 'provider_id'), ':///', 2), '/', 2) as provider_id,
            "timestamp"
        FROM {{ dataStoreTableName "pod-request-cpu-cores" }}
    ),
    computed_usage AS (
        SELECT pod,
            namespace,
            node,
            provider_id,
            labels,
            avg(amount) as total_amount,
            min("timestamp") as data_start,
            max("timestamp") as data_end
        FROM usage_period
        WHERE "timestamp" >= timestamp '{{.Report.StartPeriod | prestoTimestamp }}'
        AND "timestamp" <= timestamp '{{ .Report.EndPeriod | prestoTimestamp }}'
        GROUP BY pod, namespace, node, provider_id, labels
    )
    SELECT pod,
            namespace,
            node,
            provider_id,
            data_start,
            data_end,
            total_amount * date_diff('second', data_start, data_end) as cpu_usage_core_seconds
    FROM computed_usage
    ORDER BY pod, namespace, node, provider_id, data_start, data_end
