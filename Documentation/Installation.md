# Installing Chargeback

Chargeback consists of a few components:

- A daemon named promsum which retrieves usage information from Prometheus and
  persists it in S3.
- A chargeback pod which generates reports based on the collected usage
  information.
- Hive and Presto clusters, used by the chargeback pod to perform queries on the
  collected usage data.

## Prerequisites

In order to install and use chargeback the following components will be
necessary:

- AWS credentials with permission to write to and read from an S3 bucket.
- A tectonic installed Kubernetes cluster, of version 1.8.0 or greater, or with
  a Tectonic Prometheus Operator to be of version 1.6.0 or greater (Prometheus
  operator v0.13).
- A properly con***REMOVED***gured kubectl to access the Kubernetes cluster.

To alter the version of the Tectonic Prometheus operator to be 1.6.0, run the following
command:

```
kubectl -n tectonic-system patch deploy tectonic-prometheus-operator -p '{"spec":{"template":{"spec":{"containers":[{"name":"tectonic-prometheus-operator","image":"quay.io/coreos/tectonic-prometheus-operator:v1.6.0"}]}}}}'
```

Once the operator changes the version of the `kube-state-metrics` pod to 1.0.1,
chargeback installation may proceed.

## Modify Chargeback data stores

Chargeback has a few CRDs that are installed to control what types of reports
can be generated. More information on this is available in the [documentation on
Chargeback's CRD model][crd-model], but the data stores must be modi***REMOVED***ed to
point to a valid S3 bucket.

Modify the `bucket` and `pre***REMOVED***x` keys in
`manifests/chargeback-resources/data-store.yaml` to match
where the collected usage data should be stored.

As an example:

```
apiVersion: chargeback.coreos.com/prealpha
kind: ReportDataStore
metadata:
    name: "default-datastore"
    labels:
        tectonic-chargeback: "true"
spec:
    storage:
        type: "s3"
        format: "json"
        bucket: "chargeback-datastore"
        pre***REMOVED***x: "promsum/memory_by_pod"
    queries:
    - "get-memory-by-pod"
```

## Have a namespace for Chargeback to run in

Chargeback will install into an existing namespace. Without con***REMOVED***guration, the
default is currently `team-chargeback`.

If a different namespace should be used, or you need to customize the location of the docker pull-secret to pull the chargeback docker images, you can override the following environment variables (defaults are used in the example):

```
export CHARGEBACK_NAMESPACE=team-chargeback
export PULL_SECRET_NAMESPACE=tectonic-system
export PULL_SECRET=coreos-pull-secret
```

## Prometheus location

If Prometheus was setup by Tectonic and is running within the tectonic-system namespace, then you can skip this section.

If you're running the Prometheus operator yourself (not using the Tectonic one), then you need to con***REMOVED***gure the `prometheus-url` in `manifests/chargeback/chargeback-con***REMOVED***g.yaml` to match the service created by your Prometheus operator.

## Set AWS Credentials

The install script will detect if AWS credentials are stored in the environment
variables `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY`, and ask if these
credentials should be used to create a secret in Kubernetes for Chargeback to
use.

This is recommended, but if these variables are not set the install script
will print out instructions indicating which ***REMOVED***le you need to modify and create
before running `install.sh`.

## Set AWS region

Chargeback and promsum currently need to be con***REMOVED***gured to use a speci***REMOVED***c AWS
region. This is only temporary, and this requirement should be removed in the
future. Until then, change the `aws-region` value in
`manifests/chargeback/chargeback-con***REMOVED***g.yaml`.

## Run the install script

Run `./hack/install.sh` to install Chargeback on the cluster.

## Verifying operation

Check the logs of the "promsum" deployment, there should be no errors:

```
kubectl get pods -n $CHARGEBACK_NAMESPACE -l app=promsum -o name | cut -d/ -f2 | xargs -I{} kubectl -n $CHARGEBACK_NAMESPACE logs {} -f
```

## Generating reports

With Chargeback now successfully installed, reports may be generated. Note that
promsum will need to run for some time (probably over a half hour) for enough
usage data to be built up to generate a report. Reports can be generated by
creating report objects in Kubernetes in the same namespace as Chargeback. Some
examples of report objects exist in the `manifests/custom-resources/reports`
directory.

To deploy an example pod usage by memory report, ***REMOVED***rst modify
`manifests/custom-resources/reports/pod-report.yaml` and set your `bucket` and
`reportStart`/`reportEnd`, then create the report in Kubernetes:

```
kubectl -n $CHARGEBACK_NAMESPACE create -f manifests/custom-resources/reports/pod-memory-usage-by-node-report.yaml
```

Existing reports can be viewed in Kubernetes with the following command:

```
kubectl -n $CHARGEBACK_NAMESPACE get reports
```

A report's status can be inspected by viewing the object with the `-o json`
flag:

```
kubectl -n $CHARGEBACK_NAMESPACE get report pod-memory-usage -o json
```

## Uninstall

To uninstall chargeback run:
```
./hack/uninstall.sh
```

## AWS Billing data setup

**AWS billing reports were temporarily removed from chargeback due to a
refactor, the following documentation is left in for when this functionality is
restored**

* Setup hourly billing reports in the AWS console by following [these](https://docs.aws.amazon.com/awsaccountbilling/latest/aboutv2/billing-reports-gettingstarted-turnonreports.html) instructions. Be sure to note the bucket, report pre***REMOVED***x, and report name speci***REMOVED***ed here.

* Create AWS access key with permissions for the bucket given above. The required permissions are:
```
s3:DeleteObject
s3:GetObject
s3:GetObjectAcl1
s3:PutObject
s3:PutObjectAcl
s3:GetBucketAcl
s3:ListBucket
s3:GetBucketLocation
```

Once you have an `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` refer to
[Set AWS Credentials](set-aws-credentials) and [Set AWS region](set-aws-region) for con***REMOVED***guring.

[crd-model]: CRD-Model.md
