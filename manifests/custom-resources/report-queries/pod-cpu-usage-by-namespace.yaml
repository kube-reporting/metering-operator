apiVersion: chargeback.coreos.com/v1alpha1
kind: ReportGenerationQuery
metadata:
  name: "pod-cpu-usage-by-namespace"
spec:
  reportDataStore: "pod-cpu-usage"
  columns:
  - name: namespace
    type: string
  - name: cpu_usage
    type: double
  query: |
    WITH usage_period AS (
      SELECT kubeUsage.labels['namespace'] as namespace,
             kubeUsage.amount as amount,
             kubeUsage."timestamp" as timestamp
      FROM {{.TableName}} as kubeUsage
    ),
    computed_usage AS (
      SELECT namespace,
            "timestamp" as period_end,
             lag("timestamp") OVER (PARTITION BY namespace ORDER BY "timestamp" ASC) as period_start,
            (amount + lag(amount) OVER (PARTITION BY namespace ORDER BY "timestamp" ASC)) / 2 as usage
      FROM usage_period
    )
    SELECT namespace,
           sum(usage * date_diff('millisecond', period_start, period_end)) as cpu_usage
    FROM computed_usage
    WHERE period_start >= timestamp '{{.StartPeriod | prestoTimestamp }}'
    AND period_end <= timestamp '{{ .EndPeriod | prestoTimestamp }}'
    GROUP BY namespace
